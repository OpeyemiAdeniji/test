name: Update Port with YouTube Playlist Data
on:
  workflow_dispatch:
    inputs:
      playlistid:
        description: 'ID of the YouTube playlist'
        required: true
      port_context:
        description: 'Port context payload'
        required: true

jobs:
  obtain_token:
    runs-on: ubuntu-latest
    outputs:
      access_token: ${{ steps.get_token.outputs.token }}  # Fixed output reference
    env:
      PORT_CLIENT_ID: ${{ secrets.PORT_CLIENT_ID }}
      PORT_CLIENT_SECRET: ${{ secrets.PORT_CLIENT_SECRET }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq for JSON processing
        run: sudo apt-get install -y jq

      - name: Get Port access token
        id: get_token
        run: |
          set -e
          PORT_CLIENT_ID=$(echo "$PORT_CLIENT_ID" | xargs)
          PORT_CLIENT_SECRET=$(echo "$PORT_CLIENT_SECRET" | xargs)

          get_port_access_token() {
            response=$(curl -s -X POST "https://api.getport.io/v1/auth/access_token" \
              -H "Content-Type: application/json" \
              -d '{
                "clientId": "'"$PORT_CLIENT_ID"'",
                "clientSecret": "'"$PORT_CLIENT_SECRET"'"
              }')

            if echo "$response" | grep -q '"ok":false'; then
              echo "Error obtaining access token: $(echo "$response" | jq -r '.message')"
              exit 1
            fi

            access_token=$(echo "$response" | jq -r '.accessToken // empty')
            if [ -z "$access_token" ]; then
              echo "Error: Failed to retrieve access token. Response: $response"
              exit 1
            fi

            echo "$access_token"
          }

          ACCESS_TOKEN=$(get_port_access_token)

          # Validate token format
          if [[ -z "$ACCESS_TOKEN" ]]; then
            echo "Error: Access token is empty. Please check client credentials."
            exit 1
          fi

          if ! [[ "$ACCESS_TOKEN" =~ ^[a-zA-Z0-9_-]+\.[a-zA-Z0-9_-]+\.[a-zA-Z0-9_-]+$ ]]; then
            echo "Error: Invalid JWT format detected or empty token."
            exit 1
          fi

          # Use the newer GitHub Actions output syntax
          echo "token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT

  process_playlist:
    runs-on: ubuntu-latest
    needs: obtain_token
    env:
      YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
      PLAYLIST_ID: ${{ inputs.playlistid }}

    steps:
      - name: Install jq for JSON processing
        run: sudo apt-get install -y jq

      - name: Fetch playlist details and report to Port
        id: fetch_playlist
        env:
          ACCESS_TOKEN: ${{ needs.obtain_token.outputs.access_token }}
        run: |
          set -e
          playlist_response=$(curl -s "https://www.googleapis.com/youtube/v3/playlists?part=snippet,contentDetails,status&id=${PLAYLIST_ID}&key=${YOUTUBE_API_KEY}")
          playlist_id=$(echo $playlist_response | jq -r '.items[0].id')
          playlist_title=$(echo $playlist_response | jq -r '.items[0].snippet.title')
          playlist_description=$(echo $playlist_response | jq -r '.items[0].snippet.description')
          playlist_thumbnail=$(echo $playlist_response | jq -r '.items[0].snippet.thumbnails.default.url')
          playlist_video_count=$(echo $playlist_response | jq -r '.items[0].contentDetails.itemCount')
          playlist_published_at=$(echo $playlist_response | jq -r '.items[0].snippet.publishedAt')

          # Debug output
          echo "Debug - Access Token: ${ACCESS_TOKEN:0:10}..."

          playlist_entity=$(jq -n --arg id "$playlist_id" --arg title "$playlist_title" \
            --arg description "$playlist_description" --arg thumbnailUrl "$playlist_thumbnail" \
            --arg videoCount "$playlist_video_count" --arg created_at "$playlist_published_at" \
            '{
              identifier: $id,
              title: $title,
              properties: {
                playlistId: $id,
                title: $title,
                description: $description,
                thumbnailUrl: $thumbnailUrl,
                videoCount: ($videoCount | tonumber),
                created_at: $created_at
              }
            }')

          echo "Payload: $playlist_entity"
          response=$(curl -v -X POST "https://api.getport.io/v1/blueprints/playlist/entities?upsert=true" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$playlist_entity")

          echo "Response: $response"
          if echo "$response" | jq -e '.ok == false' > /dev/null; then
            echo "Error: $(echo "$response" | jq -r '.message')"
            exit 1
          fi

  process_videos:
    runs-on: ubuntu-latest
    needs: [obtain_token, process_playlist]
    env:
      YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
      PLAYLIST_ID: ${{ inputs.playlistid }}

    steps:
      - name: Install jq for JSON processing
        run: sudo apt-get install -y jq

      - name: Fetch and process videos
        env:
          ACCESS_TOKEN: ${{ needs.obtain_token.outputs.access_token }}
        run: |
          # Rest of the video processing code remains the same...
